<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Journey - Departing & Transcending</title>
    <style>
        body { margin: 0; overflow: hidden; background: linear-gradient(135deg, #1e3c72, #2a5298, #7e8ba3); }
        canvas { display: block; }
        .title { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); color: #fff; font-family: serif; font-size: 24px; letter-spacing: 2px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="title">DEPARTING & TRANSCENDING</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="../particle-being-library.js"></script>
    <script>
        let scene, camera, renderer, particleSystem;
        let time = 0;
        let starField = [];
        let essenceParticles = [];
        let memoryEchoes = [];

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Create starfield background
            for (let i = 0; i < 200; i++) {
                const star = new THREE.Mesh(
                    new THREE.SphereGeometry(0.05, 4, 4),
                    new THREE.MeshBasicMaterial({
                        color: 0xffffff,
                        transparent: true,
                        opacity: Math.random() * 0.8
                    })
                );
                star.position.set(
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 100
                );
                scene.add(star);
                starField.push(star);
            }

            // Departing figure - peaceful, dissolving into cosmos
            particleSystem = new ParticleBeingSystem(scene, {
                particleCount: 350,
                particleSize: 0.08,
                speedMultiplier: 0.3,
                colorRange: { h: 0.6, s: 0.1, lMin: 0.6, lMax: 0.9 }
            });

            const departing = particleSystem.convertToParticleBeing(
                null,
                { x: 0, y: 0, z: 0 },
                {
                    particleCount: 400,
                    states: ['reflecting', 'releasing', 'ascending', 'merging'],
                    stateTimings: { reflecting: 6, releasing: 5, ascending: 6, merging: 8 },
                    attractionForces: { reflecting: 0.02, releasing: 0.012, ascending: 0.008, merging: 0.003 }
                }
            );

            // Departing behaviors - final transcendence
            const originalUpdate = particleSystem.updateBeing.bind(particleSystem);
            particleSystem.updateBeing = function(being, deltaTime) {
                originalUpdate(being, deltaTime);
                
                if (being.userData.state === 'reflecting') {
                    // Looking back on life
                    being.userData.basePosition.x = Math.sin(time * 0.3) * 2;
                    
                    // Memory echoes appear
                    if (Math.random() < 0.02) {
                        // Create memory echo figures
                        for (let age = 0; age < 5; age++) {
                            const echo = new THREE.Mesh(
                                new THREE.SphereGeometry(0.1, 6, 6),
                                new THREE.MeshBasicMaterial({
                                    color: new THREE.Color().setHSL(0.1 * age, 0.3, 0.7),
                                    transparent: true,
                                    opacity: 0.3
                                })
                            );
                            echo.position.set(
                                -15 + age * 7,
                                Math.random() * 5,
                                (Math.random() - 0.5) * 10
                            );
                            echo.userData = {
                                age: age,
                                life: 0
                            };
                            scene.add(echo);
                            memoryEchoes.push(echo);
                        }
                    }
                    
                    // Particles shimmer with memories
                    being.particles.forEach((particle, i) => {
                        if (Math.random() < 0.01) {
                            particle.material.color.setHSL(Math.random(), 0.3, 0.8);
                        }
                    });
                } else if (being.userData.state === 'releasing') {
                    // Letting go, particles begin to drift
                    being.particles.forEach((particle, i) => {
                        if (i % 10 === 0) {
                            // Release essence particles
                            const essence = new THREE.Mesh(
                                new THREE.SphereGeometry(0.06, 4, 4),
                                new THREE.MeshBasicMaterial({
                                    color: 0xaaccff,
                                    transparent: true,
                                    opacity: 0.7
                                })
                            );
                            essence.position.copy(particle.position);
                            essence.userData = {
                                velocity: new THREE.Vector3(
                                    (Math.random() - 0.5) * 0.05,
                                    Math.random() * 0.1,
                                    (Math.random() - 0.5) * 0.05
                                ),
                                life: 0
                            };
                            scene.add(essence);
                            essenceParticles.push(essence);
                        }
                        
                        // Particles gradually become lighter
                        particle.material.color.lerp(new THREE.Color(0xffffff), 0.002);
                        particle.userData.attractionForce *= 0.99;
                    });
                } else if (being.userData.state === 'ascending') {
                    // Rising toward the cosmos
                    being.userData.basePosition.y += 0.05;
                    
                    // Particles become more ethereal
                    being.particles.forEach((particle, i) => {
                        particle.material.opacity = particle.userData.originalOpacity * 
                            (0.7 - being.userData.stateTimer / 6 * 0.4);
                        
                        // Upward drift
                        particle.userData.velocity.y += 0.001;
                        
                        // Transform to light
                        particle.material.color.setHSL(
                            0.6 + Math.sin(time + i * 0.1) * 0.1,
                            0.2,
                            0.8 + Math.sin(time * 2 + i * 0.05) * 0.2
                        );
                    });
                } else if (being.userData.state === 'merging') {
                    // Merging with the cosmos
                    being.particles.forEach((particle, i) => {
                        // Particles spread out into universe
                        const cosmicDrift = new THREE.Vector3(
                            (Math.random() - 0.5) * 0.02,
                            Math.random() * 0.02,
                            (Math.random() - 0.5) * 0.02
                        );
                        particle.userData.velocity.add(cosmicDrift);
                        
                        // Fade into stardust
                        particle.material.opacity = Math.max(0, 
                            particle.userData.originalOpacity * (1 - being.userData.stateTimer / 8));
                        
                        // Become stars
                        if (particle.material.opacity < 0.3 && Math.random() < 0.001) {
                            particle.material.color.set(0xffffff);
                            particle.material.opacity = 0.8;
                            particle.userData.velocity.set(0, 0, 0);
                        }
                    });
                    
                    // Create new stars where particles fade
                    if (Math.random() < 0.05) {
                        const newStar = new THREE.Mesh(
                            new THREE.SphereGeometry(0.1, 6, 6),
                            new THREE.MeshBasicMaterial({
                                color: 0xffffff,
                                transparent: true,
                                opacity: 0
                            })
                        );
                        newStar.position.set(
                            being.userData.basePosition.x + (Math.random() - 0.5) * 20,
                            being.userData.basePosition.y + Math.random() * 10,
                            being.userData.basePosition.z + (Math.random() - 0.5) * 20
                        );
                        scene.add(newStar);
                        starField.push(newStar);
                    }
                }
                
                // Update essence particles
                essenceParticles = essenceParticles.filter(essence => {
                    essence.userData.life += 0.016;
                    essence.position.add(essence.userData.velocity);
                    essence.userData.velocity.y += 0.0008;
                    essence.material.opacity = Math.max(0, 0.7 - essence.userData.life * 0.05);
                    
                    if (essence.material.opacity <= 0) {
                        scene.remove(essence);
                        return false;
                    }
                    return true;
                });
                
                // Update memory echoes
                memoryEchoes = memoryEchoes.filter(echo => {
                    echo.userData.life += 0.016;
                    echo.material.opacity = Math.max(0, 0.3 - echo.userData.life * 0.03);
                    echo.position.y += 0.01;
                    echo.scale.setScalar(1 + echo.userData.life * 0.1);
                    
                    if (echo.material.opacity <= 0) {
                        scene.remove(echo);
                        return false;
                    }
                    return true;
                });
                
                // Update starfield
                starField.forEach(star => {
                    if (star.material.opacity < 0.8) {
                        star.material.opacity += 0.001;
                    }
                    // Gentle twinkling
                    star.material.opacity = Math.min(0.9, 
                        star.material.opacity * (0.9 + Math.sin(time * 5 + star.position.x) * 0.1));
                });
            };

            particleSystem.createAmbientParticles(50);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;
            particleSystem.update(0.016);
            
            // Slow, contemplative camera movement
            camera.position.x = Math.sin(time * 0.02) * 30;
            camera.position.z = 30 + Math.cos(time * 0.02) * 20;
            camera.position.y = 10 + Math.sin(time * 0.01) * 10;
            camera.lookAt(0, 5, 0);
            
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>